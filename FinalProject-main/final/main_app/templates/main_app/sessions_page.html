{% extends 'main_app/home_page.html' %}
{% load static %}

{% block content %}
<main>
    <section class="sessions">
        <h2>{{ company_name }} Audit Sessions</h2>
        <p>This page shows your active audit sessions for {{ company_name }}.</p>

        <!-- Dropdown to select company -->
        <label for="company-select">Choose a company to audit:</label>
        <select id="company-select">
            <option value="">Select a company</option>
            {% for company in companies %}
                <option value="{{ company.id }}">{{ company.name }}</option>
            {% endfor %}
        </select>

        <div id="subcontrols-container">
            <h3>Sub-controls</h3>
            <div id="subcontrols-list">
                <!-- Sub-controls will be populated here based on selected company -->
            </div>
        </div>

        <!-- Existing session cards showing sub-control details -->
        {% for control_info in sub_controls_with_files %}
        <div class="session-card" data-sub-control="{{ control_info.name }}">
            <h3>{{ control_info.name }}</h3>
            {% if control_info.files %}
                <ul>
                    {% for file in control_info.files %}
                        <li>
                            <a href="{{ file.file.url }}" target="_blank">{{ file.file.name }}</a>
                            (Status: {{ file.status }})
                            <!-- Add Remove Button -->
                            <form method="POST" action="{% url 'main_app:remove_audit_file' file.id %}">
                                {% csrf_token %}
                                <button type="submit">Remove</button>
                            </form>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No evidence uploaded yet.</p>
            {% endif %}
            <button class="upload-evidence-btn">Upload Additional Evidence</button>
        </div>
        {% endfor %}
    </section>
</main>

<!-- Modal for File Upload -->
<div id="audit-trail-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 id="modal-company-name"></h3>

        <form action="{% url 'main_app:upload_audit_files' %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="company_id" id="company_id_field" value="{{ company.id }}">
            <input type="hidden" name="sub_control" id="sub_control_field">

            <label for="evidence-upload">Upload Evidence (Multiple Files Allowed)</label>
            <input type="file" name="files" id="evidence-upload" accept=".pdf, .docx, .txt" multiple required>
            <button type="submit">Submit</button>
        </form>
        <p id="upload-status" style="color:green;"></p>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Handle company selection
        $('#company-select').on('change', function() {
            var companyId = $(this).val();
            if (companyId) {
                loadSubcontrols(companyId);
            } else {
                $('#subcontrols-list').empty();
            }
        });

        // Function to load subcontrols based on selected company
       function loadSubcontrols(companyId) {
    $.ajax({
        url: "{% url 'main_app:fetch_subcontrols' %}",
        method: "GET",
        data: { company_id: companyId },
        success: function(response) {
            $('#subcontrols-list').empty();  // Clear existing subcontrols
            if (response.subcontrols.length > 0) {
                response.subcontrols.forEach(function(subcontrol) {
                    var subcontrolHtml = `
                        <div class="session-card" data-sub-control="${subcontrol.name}">
                            <h3>${subcontrol.name}</h3>
                            <ul>
                                ${subcontrol.files.length > 0 ? subcontrol.files.map(function(file) {
                                    return `
                                        <li>
                                            <a href="${file.file.url}" target="_blank">${file.file.name}</a>
                                            (Status: ${file.status})
                                            <!-- Remove button form -->
                                            <form method="POST" action="/remove_audit_file/${file.id}/">
                                                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                                <button type="submit">Remove</button>
                                            </form>
                                        </li>
                                    `;
                                }).join('') : '<p>No evidence uploaded yet.</p>'}
                            </ul>
                            <button class="upload-evidence-btn">Upload Additional Evidence</button>
                        </div>
                    `;
                    $('#subcontrols-list').append(subcontrolHtml);
                });
            } else {
                $('#subcontrols-list').append('<p>No subcontrols found for this company.</p>');
            }
        },
        error: function(xhr, status, error) {
            console.error("Error loading subcontrols:", error);
        }
    });
}


        // Open modal when the "Upload Additional Evidence" button is clicked
        $('.upload-evidence-btn').on('click', function() {
            var subControl = $(this).closest('.session-card').data('sub-control');
            $('#modal-company-name').text("Upload Evidence for " + subControl);
            $('#sub_control_field').val(subControl);
            $('#audit-trail-modal').fadeIn(); // Fade in modal instead of show() for smoother transition
        });

        // Close modal when the "x" is clicked
        $('.close').on('click', function() {
            $('#audit-trail-modal').fadeOut();
            resetUpload();
        });

        // Close modal when clicking outside the modal content
        $(window).on('click', function(event) {
            if ($(event.target).is('#audit-trail-modal')) {
                $('#audit-trail-modal').fadeOut();
                resetUpload();
            }
        });

        // Reset the form and status after closing the modal
        function resetUpload() {
            $('#evidence-upload').val('');
            $('#upload-status').text('');
        }
    });
</script>

<style>
    /* General Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    main { max-width: 900px; margin: 20px auto; padding: 20px; background: #4d4d4d; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }

    .sessions { margin-bottom: 40px; background-color: #4d4d4d; }

    .session-card { background-color: rgb(0, 0, 0); padding: 20px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); text-align: center; }

    .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5); padding-top: 60px; }

    .modal-content { background-color: #505050; margin: auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px; text-align: center; }

    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }

    .close:hover { color: black; }
</style>

{% endblock %}
